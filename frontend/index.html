<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>A股自选 + K线图 V0.5版</title>
<!-- 引入jQuery和Bootstrap -->
<script src="jquery-3.6.0.min.js"></script>
<link href="bootstrap.min.css" rel="stylesheet">
<script src="bootstrap.bundle.min.js"></script>
<style>
    body { font-family: Arial; margin: 0; padding: 10px; }
    #top-bar { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
    
    /* 左右布局容器 */
    #main-container { 
        display: flex; 
        gap: 10px; 
        height: calc(100vh - 100px); 
    }
    
    #watchlist { 
        border: 1px solid #ccc; 
        width: 300px; 
        padding: 5px; 
        overflow-y: auto;
        flex-shrink: 0;
    }
    
    #watchlist table { width: 100%; border-collapse: collapse; }
    #watchlist th, #watchlist td { border-bottom: 1px solid #eee; padding: 4px; text-align: left; }
    
    #chart-container { 
        flex: 1; 
        min-width: calc(100vw - 350px);
        overflow-y: auto;
    }
    
    #mainChart { width: 100%; height: 400px; }
    #volumeChart, #macdChart, #rsiChart { width: 100%; height: 100px; margin-top: 10px; }
    
    .increase { color: #f53f3f; }
    .decrease { color: #00b42a; }
    .indicator-controls { margin: 10px 0; }
    .indicator-controls label { margin-right: 15px; }
    
    /* 删除按钮样式 */
    .delete-btn { 
        background: #ff4d4f; 
        color: white; 
        border: none; 
        border-radius: 3px; 
        padding: 2px 6px; 
        cursor: pointer; 
        font-size: 12px;
    }
    .delete-btn:hover { background: #ff7875; }
    
    /* 自选股控制按钮样式 */
    .watchlist-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    
    .watchlist-controls {
        display: flex;
        gap: 5px;
    }
    
    .refresh-btn, .auto-refresh-btn {
        background: #1890ff;
        color: white;
        border: none;
        border-radius: 3px;
        padding: 4px 8px;
        cursor: pointer;
        font-size: 12px;
    }
    
    .refresh-btn:hover, .auto-refresh-btn:hover {
        background: #40a9ff;
    }
    
    .auto-refresh-btn.active {
        background: #52c41a;
    }
    
    .auto-refresh-btn.active:hover {
        background: #73d13d;
    }
    
    .refresh-time {
        font-size: 12px;
        color: #666;
        margin-bottom: 10px;
        text-align: right;
    }
    
    /* 图表区域样式 */
    .chart-section { 
        margin-bottom: 20px; 
        border: 1px solid #e8e8e8; 
        border-radius: 4px; 
        padding: 10px; 
        background: #fafafa;
    }
    
    .chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #e9ecef;
}

.stock-title {
    display: flex;
    align-items: center;
    gap: 15px;
}

.stock-name {
    font-size: 20px;
    font-weight: bold;
    color: #1890ff;
}

.stock-code {
    font-size: 16px;
    color: #666;
    background: #e6f7ff;
    padding: 4px 8px;
    border-radius: 4px;
    border: 1px solid #91d5ff;
}

.chart-controls {
    display: flex;
    align-items: center;
    gap: 20px;
}

.chart-header h3 { 
    margin: 0; 
    color: #333; 
    font-size: 16px;
}

.indicator-info { 
    display: flex; 
    gap: 15px; 
    font-size: 12px; 
    color: #666;
}

.indicator-info span { 
    white-space: nowrap;
}
    
    /* 指标选择器样式 */
    .indicator-selector {
        margin: 10px 0;
        padding: 10px;
        background: #f5f5f5;
        border-radius: 4px;
    }
    
    .indicator-selector h4 {
        margin: 0 0 10px 0;
        color: #333;
        font-size: 14px;
    }
    
    .indicator-options {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }
    
    .indicator-option {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 12px;
    }
    
    /* 自选股选中效果 */
    .watchlist-item {
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .watchlist-item:hover {
        background-color: #f8f9fa;
    }
    
    .watchlist-item.selected {
        background-color: #e3f2fd;
        border-left: 4px solid #1890ff;
        font-weight: bold;
    }
    
    .watchlist-item.loading {
        background-color: #fff3cd;
        position: relative;
        overflow: hidden;
    }
    
    .watchlist-item.loading::after {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.6), transparent);
        animation: loading 1.5s infinite;
    }
    
    @keyframes loading {
        0% { left: -100%; }
        100% { left: 100%; }
    }
    
    /* 加载状态样式 */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255,255,255,0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        backdrop-filter: blur(2px);
    }
    
    .loading-spinner {
        width: 50px;
        height: 50px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #1890ff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .loading-text {
        margin-top: 15px;
        color: #1890ff;
        font-size: 16px;
        font-weight: bold;
    }
    
    /* 浮动信息标签样式 */
    .crosshair-info {
        position: absolute;
        background: rgba(0, 0, 0, 0.85);
        color: white;
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 12px;
        font-family: 'Courier New', monospace;
        pointer-events: none;
        z-index: 1000;
        min-width: 180px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(4px);
        display: none;
    }
    
    .crosshair-info .info-row {
        display: flex;
        justify-content: space-between;
        margin: 2px 0;
        line-height: 1.3;
    }
    
    .crosshair-info .info-label {
        color: #ccc;
        margin-right: 10px;
        min-width: 60px;
    }
    
    .crosshair-info .info-value {
        color: white;
        font-weight: bold;
        text-align: right;
        flex: 1;
    }
    
    .crosshair-info .increase {
        color: #f53f3f;
    }
    
    .crosshair-info .decrease {
        color: #00b42a;
    }
    
    .crosshair-info .date-row {
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        padding-bottom: 4px;
        margin-bottom: 4px;
        font-weight: bold;
    }
    
    /* 主图容器相对定位，用于浮动标签定位 */
    #mainChart {
        position: relative;
    }
 </style>
 </head>
<body>
<div id="top-bar">
    <input type="text" id="stockInput" placeholder="输入股票代码或名称">
    <button id="searchBtn">查询</button>
    <button id="addWatchBtn">加入自选</button>
</div>

<div id="indicator-controls" class="indicator-controls">
    <label><input type="checkbox" id="showLabels" checked> 标签开关</label>
    <label><input type="checkbox" id="showMacd" checked> 显示MACD</label>
    <label><input type="checkbox" id="showRsi" checked> 显示RSI</label>
    <label><input type="checkbox" id="showSkdj" checked> 显示SKDJ</label>
    <label><input type="checkbox" id="showKdj" checked> 显示KDJ</label>
    <label><input type="checkbox" id="showTrix" checked> 显示TRIX</label>
    <label><input type="checkbox" id="showBbi" checked> 显示BBI</label>
    <label><input type="checkbox" id="showMk" checked> 显示MK共振</label>
    <label><input type="checkbox" id="showStrategy" checked> 显示策略信号</label>
    <label><input type="checkbox" id="showVol" checked> 显示成交量</label>
    <label><input type="checkbox" id="showObv" checked> 显示OBV</label>
    <label><input type="checkbox" id="showMfi" checked> 显示MFI</label>
    <label><input type="checkbox" id="showCci" checked> 显示CCI</label>
    <label><input type="checkbox" id="showRoc" checked> 显示ROC</label>
    <label><input type="checkbox" id="showWilliams" checked> 显示William %R</label>
</div>

<!-- 左右布局容器 -->
<div id="main-container">
    <!-- 左侧：自选列表 -->
    <div id="watchlist">
        <div class="watchlist-header">
            <h3>自选列表</h3>
            <div class="watchlist-controls">
                <button id="refreshBtn" onclick="refreshWatchlist()" class="refresh-btn">刷新</button>
                <button id="autoRefreshBtn" onclick="toggleAutoRefresh()" class="auto-refresh-btn">自动刷新</button>
            </div>
        </div>
        <div id="lastRefreshTime" class="refresh-time">最后刷新: --</div>
        <table id="watchlistTable" style="font-size: 12px;">
            <thead>
                <tr><th>代码</th><th>名称</th><th>价格</th><th>涨幅</th><th>操作</th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- 右侧：图表区域 -->
    <div id="chart-container">
        <!-- 主K线图 -->
        <div class="chart-section">
            <div class="chart-header">
                <div class="stock-title">
                    <span id="stockName" class="stock-name">--</span>
                    <span id="stockCode" class="stock-code">--</span>
                </div>
                <div class="chart-controls">
                    <h3>K线图</h3>
                    <div class="indicator-selector">
                        <h4>主图指标显示控制</h4>
                        <div class="indicator-options">
                            <div class="indicator-option">
                                <input type="checkbox" id="showBB" checked>
                                <label for="showBB">布林带 BB(20,2)</label>
                            </div>
                            <div class="indicator-option">
                                <input type="checkbox" id="showSupertrend" checked>
                                <label for="showSupertrend">超级趋势(10,3)</label>
                            </div>
                            <div class="indicator-option">
                                <input type="checkbox" id="showMultiMA" checked>
                                <label for="showMultiMA">多重移动平均线</label>
                            </div>
                            <div class="indicator-option">
                                <input type="checkbox" id="showZigZag" checked>
                                <label for="showZigZag">ZigZag波段拐点</label>
                            </div>
                            <div class="indicator-option">
                                <input type="checkbox" id="showPivot" checked>
                                <label for="showPivot">PIVOT枢轴点</label>
                            </div>
                            <div class="indicator-option">
                                <input type="checkbox" id="showDonchian" checked>
                                <label for="showDonchian">唐奇安通道</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="mainChart">
                <div id="crosshairInfo" class="crosshair-info">
                    <div class="info-row date-row">
                        <span class="info-label">日期</span>
                        <span class="info-value" id="crosshairDate">--</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">开盘</span>
                        <span class="info-value" id="crosshairOpen">--</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">最高</span>
                        <span class="info-value" id="crosshairHigh">--</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">最低</span>
                        <span class="info-value" id="crosshairLow">--</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">收盘</span>
                        <span class="info-value" id="crosshairClose">--</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">涨幅</span>
                        <span class="info-value" id="crosshairChange">--</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">成交量</span>
                        <span class="info-value" id="crosshairVolume">--</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">成交额</span>
                        <span class="info-value" id="crosshairAmount">--</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">换手率</span>
                        <span class="info-value" id="crosshairTurnover">--</span>
                    </div>
                </div>
            </div>
            
            <div class="indicator-info">
                <span>MA5: 5日移动平均线</span>
                <span>MA10: 10日移动平均线</span>
                <span>MA20: 20日移动平均线</span>
                <span>BB(20,2): 布林带指标</span>
                <span>Supertrend(10,3): 超级趋势</span>
                <span>MA多重: 14,21,35,50,100,200</span>
            </div>
        </div>
        
        <!-- 成交量图 -->
        <div class="chart-section" id="volumeSection">
            <div class="chart-header">
                <h3>成交量</h3>
                <div class="indicator-info">
                    <span>红色: 上涨成交量</span>
                    <span>绿色: 下跌成交量</span>
                </div>
            </div>
            <div id="volumeChart"></div>
        </div>
        
        <!-- MACD图 -->
        <div class="chart-section" id="macdSection">
            <div class="chart-header">
                <h3>MACD (12,26,9)</h3>
                <div class="indicator-info">
                    <span>DIF: 快线 (紫色线)</span>
                    <span>DEA: 慢线 (橙色线)</span>
                    <span>MACD柱: 红绿实心/空心柱状图</span>
                    <span>金叉: DIF上穿DEA (绿色标记)</span>
                    <span>死叉: DIF下穿DEA (红色标记)</span>
                </div>
            </div>
            <div id="macdChart"></div>
        </div>
        
        <!-- Stoch RSI图 -->
        <div class="chart-section" id="rsiSection">
            <div class="chart-header">
                <h3>Stoch RSI (14,14,3,3)</h3>
                <div class="indicator-info">
                    <span>Stoch RSI: 随机相对强弱指标</span>
                    <span>K线: 快线</span>
                    <span>D线: 慢线</span>
                    <span>超买区: &gt;0.8</span>
                    <span>超卖区: &lt;0.2</span>
                </div>
            </div>
            <div id="rsiChart"></div>
        </div>
        
        <!-- SKDJ图 -->
        <div class="chart-section" id="skdjSection">
            <div class="chart-header">
                <h3>SKDJ (9,3)</h3>
                <div class="indicator-info">
                    <span>SKDJ: 随机指标</span>
                    <span>K线: 快线 (蓝色)</span>
                    <span>D线: 慢线 (橙色)</span>
                    <span>超买区: >80</span>
                    <span>超卖区: <20</span>
                </div>
            </div>
            <div id="skdjChart"></div>
        </div>

        <!-- MK共振图 -->
        <div class="chart-section" id="mkSection">
            <div class="chart-header">
                <h3>MK共振</h3>
                <div class="indicator-info">
                    <span>MK共振: 多指标共振信号</span>
                    <span>金叉: 买入信号 (绿圆)</span>
                    <span>死叉: 卖出信号 (红圆)</span>
                    <span>强信号: 大圆表示</span>
                </div>
            </div>
            <div id="mkChart"></div>
        </div>

        <!-- 策略信号图 -->
        <div class="chart-section" id="strategySection">
            <div class="chart-header">
                <h3>策略信号</h3>
                <div class="indicator-info">
                    <span>TD9: 抄底做多战法 (紫色三角)</span>
                    <span>EMA: EMA交易策略 (青色方块)</span>
                    <span>超级波段: 超级波段追踪多头策略 (金色菱形)</span>
                </div>
            </div>
            <div id="strategyChart"></div>
        </div>

        <!-- OBV图 -->
        <div class="chart-section" id="obvSection">
            <div class="chart-header">
                <h3>OBV（能量潮）</h3>
                <div class="indicator-info">
                    <span>OBV: 成交量与价格关系的能量潮指标</span>
                    <span>核心价值: 量价背离识别超准</span>
                    <span>上涨无量: OBV不会上升 → 可提前识别假突破</span>
                </div>
            </div>
            <div id="obvChart"></div>
        </div>

        <!-- MFI图 -->
        <div class="chart-section" id="mfiSection">
            <div class="chart-header">
                <h3>MFI（资金流量指数）</h3>
                <div class="indicator-info">
                    <span>MFI: RSI与成交量的结合指标</span>
                    <span>强势行情: MFI 80以上背离 → 见顶信号很可靠</span>
                    <span>超买区: &gt;80 (红色)</span>
                    <span>超卖区: &lt;20 (绿色)</span>
                </div>
            </div>
            <div id="mfiChart"></div>
        </div>

        <!-- CCI图 -->
        <div class="chart-section" id="cciSection">
            <div class="chart-header">
                <h3>CCI（商品通道指标）</h3>
                <div class="indicator-info">
                    <span>CCI20: 20日商品通道指标</span>
                    <span>CCI14: 14日商品通道指标</span>
                    <span>多头强势: CCI &gt; 100</span>
                    <span>超卖区域: CCI &lt; -100</span>
                    <span>核心价值: A股短线歼灭战核心指标</span>
                </div>
            </div>
            <div id="cciChart"></div>
        </div>

        <!-- ROC图 -->
        <div class="chart-section" id="rocSection">
            <div class="chart-header">
                <h3>ROC（变动率指标）</h3>
                <div class="indicator-info">
                    <span>ROC10: 10日变动率指标</span>
                    <span>ROC20: 20日变动率指标</span>
                    <span>用途: 衡量加速上涨或加速下跌</span>
                    <span>特点: 非常适合打板风格筛选强势股</span>
                </div>
            </div>
            <div id="rocChart"></div>
        </div>

        <!-- William %R图 -->
        <div class="chart-section" id="williamsSection">
            <div class="chart-header">
                <h3>William %R（威廉指标）</h3>
                <div class="indicator-info">
                    <span>WR14: 14日威廉指标</span>
                    <span>特点: 比RSI更敏感，适合追踪强势股回踩买点</span>
                    <span>超买区: &lt; -20</span>
                    <span>超卖区: &gt; -80</span>
                </div>
            </div>
            <div id="williamsChart"></div>
        </div>

        <!-- KDJ图 -->
        <div class="chart-section" id="kdjSection">
            <div class="chart-header">
                <h3>KDJ（随机指标）</h3>
                <div class="indicator-info">
                    <span>KDJ: 经典随机指标，适合短线交易</span>
                    <span>K线: 快线 (蓝色)</span>
                    <span>D线: 慢线 (橙色)</span>
                    <span>J线: 超快线 (红色)</span>
                    <span>超买区: &gt;80</span>
                    <span>超卖区: &lt;20</span>
                    <span>金叉死叉: K、D线的反转点对A股短线非常有用</span>
                </div>
            </div>
            <div id="kdjChart"></div>
        </div>

        <!-- TRIX图 -->
        <div class="chart-section" id="trixSection">
            <div class="chart-header">
                <h3>TRIX（三重指数平滑）</h3>
                <div class="indicator-info">
                    <span>TRIX: 三重指数平滑移动平均</span>
                    <span>特点: 适合捕捉真正的"趋势反转点"</span>
                    <span>优势: 比MACD更不容易被震荡骗线</span>
                    <span>信号线: TRIX信号线 (橙色)</span>
                    <span>金叉死叉: TRIX与信号线的交叉</span>
                </div>
            </div>
            <div id="trixChart"></div>
        </div>

        <!-- BBI图 -->
        <div class="chart-section" id="bbiSection">
            <div class="chart-header">
                <h3>BBI（多空指数）</h3>
                <div class="indicator-info">
                    <span>BBI: 多均线综合趋势线</span>
                    <span>公式: (MA3 + MA6 + MA12 + MA24) / 4</span>
                    <span>特点: A股民间非常常用的跟踪趋势线</span>
                    <span>优势: 移动更圆润，过滤短期噪音</span>
                    <span>用法: 作为多空分界线，价格在BBI之上为多头，之下为空头</span>
                </div>
            </div>
            <div id="bbiChart"></div>
        </div>



    </div>
</div>

<script src="lightweight-charts.standalone.production.js"></script>
<script>
// 从localStorage加载自选股数据
let watchlist = JSON.parse(localStorage.getItem('stockWatchlist')) || [];

// 当前选中的股票代码
let selectedStockCode = null;

// 加载状态管理
let isLoading = false;

// 显示加载状态
function showLoading() {
    if (isLoading) return;
    
    isLoading = true;
    const overlay = document.createElement('div');
    overlay.className = 'loading-overlay';
    overlay.id = 'loadingOverlay';
    overlay.innerHTML = `
        <div class="text-center">
            <div class="loading-spinner"></div>
            <div class="loading-text">正在加载数据...</div>
        </div>
    `;
    document.body.appendChild(overlay);
}

// 隐藏加载状态
function hideLoading() {
    isLoading = false;
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) {
        overlay.remove();
    }
}

// 选中股票并更新样式
function selectStock(stockCode) {
    // 移除之前选中的样式
    $('.watchlist-item.selected').removeClass('selected');
    $('.watchlist-item.loading').removeClass('loading');
    
    // 设置新的选中状态
    selectedStockCode = stockCode;
    
    // 为当前选中的行添加选中样式
    const rows = document.querySelectorAll('#watchlistTable tbody tr');
    rows.forEach(row => {
        const codeCell = row.cells[0];
        if (codeCell && codeCell.textContent === stockCode.replace(/^(sh|sz)/i, '')) {
            $(row).addClass('watchlist-item selected');
        }
    });
}

// 处理A股代码（添加sh/sz前缀）
function processStockCode(code) {
    // 移除可能存在的sh/sz前缀
    code = code.replace(/^(sh|sz)/i, '').trim();
    
    // 根据股票代码规则添加前缀
    if (/^[036]\d{5}$/.test(code)) {
        // 6开头的是上证，0、3开头的是深证
        if (code.startsWith('6')) {
            return 'sh' + code;
        } else {
            return 'sz' + code;
        }
    }
    return code; // 非A股代码保持原样
}

// 删除自选股
function deleteWatchlistStock(code) {
    if (confirm('确定要删除这只股票吗？')) {
        watchlist = watchlist.filter(stock => stock.code !== code);
        updateWatchlistTable();
    }
}

// 获取实时股票数据并更新自选股表格
async function updateWatchlistTable() {
    const tbody = document.querySelector('#watchlistTable tbody');
    
    if (watchlist.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999;">暂无自选股</td></tr>';
        localStorage.setItem('stockWatchlist', JSON.stringify(watchlist));
        return;
    }
    
    // 显示加载状态
    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999;">正在获取实时数据...</td></tr>';
    
    try {
        // 构建股票代码列表
        const symbolList = watchlist.map(stock => stock.code).join(',');
        
        // 调用批量实时价格接口
        const response = await fetch(`http://127.0.0.1:8000/api/realtime_prices?symbols=${symbolList}`);
        const result = await response.json();
        
        if (!response.ok) {
            throw new Error(result.error || '获取实时数据失败');
        }
        
        const realtimeData = result.data || [];
        
        // 清空表格并重新填充
        tbody.innerHTML = '';
        
        watchlist.forEach((stock, index) => {
            const tr = document.createElement('tr');
            
            // 查找对应的实时数据
            const realtimeStock = realtimeData.find(item => item.symbol === stock.code);
            
            if (realtimeStock) {
                // 使用实时数据
                const changeClass = parseFloat(realtimeStock.change) >= 0 ? 'increase' : 'decrease';
                const changeDisplay = parseFloat(realtimeStock.change) >= 0 ? `+${realtimeStock.change}%` : `${realtimeStock.change}%`;
                
                // 移除股票代码前的sh/sz前缀
                const displayCode = stock.code.replace(/^(sh|sz)/i, '');
                
                tr.innerHTML = `
                    <td>${displayCode}</td>
                    <td>${stock.name}</td>
                    <td class="${changeClass}">${realtimeStock.currentPrice}</td>
                    <td class="${changeClass}">${changeDisplay}</td>
                    <td><button class="delete-btn" onclick="deleteWatchlistStock('${stock.code}')">删除</button></td>
                `;
            } else {
                // 如果没有实时数据，显示默认信息
                // 移除股票代码前的sh/sz前缀
                const displayCode = stock.code.replace(/^(sh|sz)/i, '');
                
                tr.innerHTML = `
                    <td>${displayCode}</td>
                    <td>${stock.name}</td>
                    <td>--</td>
                    <td>--</td>
                    <td><button class="delete-btn" onclick="deleteWatchlistStock('${stock.code}')">删除</button></td>
                `;
            }
            
            tr.addEventListener('click', (e) => {
                // 防止点击删除按钮时触发股票查询
                if (e.target.tagName !== 'BUTTON') {
                    selectStock(stock.code);
                    loadKline(stock.code);
                }
            });
            tbody.appendChild(tr);
        });
        
        // 更新最后刷新时间
        updateLastRefreshTime();
        
    } catch (error) {
        console.error('获取实时数据失败:', error);
        
        // 显示错误信息
        tbody.innerHTML = '';
        watchlist.forEach((stock, index) => {
            const tr = document.createElement('tr');
            
            // 移除股票代码前的sh/sz前缀
            const displayCode = stock.code.replace(/^(sh|sz)/i, '');
            
            tr.innerHTML = `
                <td>${displayCode}</td>
                <td>${stock.name}</td>
                <td>--</td>
                <td>--</td>
                <td><button class="delete-btn" onclick="deleteWatchlistStock('${stock.code}')">删除</button></td>
            `;
            tr.addEventListener('click', (e) => {
                if (e.target.tagName !== 'BUTTON') {
                    selectStock(stock.code);
                    loadKline(stock.code);
                }
            });
            tbody.appendChild(tr);
        });
    }
    
    // 保存到localStorage
    localStorage.setItem('stockWatchlist', JSON.stringify(watchlist));
}

// 更新最后刷新时间
function updateLastRefreshTime() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('zh-CN');
    const refreshTimeElement = document.getElementById('lastRefreshTime');
    if (refreshTimeElement) {
        refreshTimeElement.textContent = `最后刷新: ${timeString}`;
    }
}

// 手动刷新自选股数据
function refreshWatchlist() {
    updateWatchlistTable();
}

// 定时刷新自选股数据（每10秒）
let refreshInterval;
function startAutoRefresh() {
    // 清除现有定时器
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }
    
    // 设置定时刷新（每10秒）
    refreshInterval = setInterval(() => {
        updateWatchlistTable();
    }, 10000);
    
    // 更新按钮状态
    const autoRefreshBtn = document.getElementById('autoRefreshBtn');
    if (autoRefreshBtn) {
        autoRefreshBtn.textContent = '停止自动刷新';
        autoRefreshBtn.classList.add('active');
    }
}

function stopAutoRefresh() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
        refreshInterval = null;
    }
    
    // 更新按钮状态
    const autoRefreshBtn = document.getElementById('autoRefreshBtn');
    if (autoRefreshBtn) {
        autoRefreshBtn.textContent = '自动刷新';
        autoRefreshBtn.classList.remove('active');
    }
}

function toggleAutoRefresh() {
    if (refreshInterval) {
        stopAutoRefresh();
    } else {
        startAutoRefresh();
    }
}

// 获取图表容器的宽度
function getChartWidth() {
    const chartContainer = document.getElementById('chart-container');
    return chartContainer ? chartContainer.clientWidth - 20 : window.innerWidth - 320;
}

// 初始化主图
const mainChart = LightweightCharts.createChart(document.getElementById('mainChart'), { 
    width: getChartWidth(), 
    height: 400,
    layout: { textColor: '#333' },
    grid: { 
        vertLines: { visible: true, color: '#f0f0f0' }, 
        horzLines: { visible: true, color: '#f0f0f0' }
    },
    crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
    timeScale: { 
        timeVisible: true, 
        secondsVisible: false,
        borderColor: '#d1d1d1',
        fixLeftEdge: true,
        fixRightEdge: true,
        barSpacing: 6,
        minBarSpacing: 3,
    },
    leftPriceScale: {  visible: false },
    rightPriceScale: { borderColor: '#d1d1d1',
        visible: true, 
        scaleMargins: { top: 0.1, bottom: 0.2 } 
    },
});

// 设置红涨绿跌的蜡烛图样式
const candleSeries = mainChart.addSeries(LightweightCharts.CandlestickSeries, {
    upColor: '#f53f3f', // 涨 - 红色
    downColor: '#00b42a', // 跌 - 绿色
    borderVisible: false,
    wickUpColor: '#f53f3f',
    wickDownColor: '#00b42a',
});

// 添加主图指标系列
const bbUpperSeries = mainChart.addSeries(LightweightCharts.LineSeries, { color: '#ffa940', lineWidth: 1, title: 'BB上轨' });
const bbLowerSeries = mainChart.addSeries(LightweightCharts.LineSeries, { color: '#ffa940', lineWidth: 1, title: 'BB下轨' });
const supertrendSeries = mainChart.addSeries(LightweightCharts.LineSeries, { color: '#722ed1', lineWidth: 2, title: '超级趋势' });
const ma14Series = mainChart.addSeries(LightweightCharts.LineSeries, { color: '#13c2c2', lineWidth: 1, title: 'MA14' });
const ma21Series = mainChart.addSeries(LightweightCharts.LineSeries, { color: '#eb2f96', lineWidth: 1, title: 'MA21' });
const ma35Series = mainChart.addSeries(LightweightCharts.LineSeries, { color: '#52c41a', lineWidth: 1, title: 'MA35' });
const ma50Series = mainChart.addSeries(LightweightCharts.LineSeries, { color: '#fa8c16', lineWidth: 1, title: 'MA50' });
const ma100Series = mainChart.addSeries(LightweightCharts.LineSeries, { color: '#1890ff', lineWidth: 1, title: 'MA100' });
const ma200Series = mainChart.addSeries(LightweightCharts.LineSeries, { color: '#722ed1', lineWidth: 1, title: 'MA200' });

// 添加新指标系列
const zigzag5Series = mainChart.addSeries(LightweightCharts.LineSeries, { color: '#fa541c', lineWidth: 2, title: 'ZigZag 5%', visible: false });
const zigzag7Series = mainChart.addSeries(LightweightCharts.LineSeries, { color: '#faad14', lineWidth: 2, title: 'ZigZag 7%', visible: false });
const pivotSeries = mainChart.addSeries(LightweightCharts.LineSeries, { color: '#722ed1', lineWidth: 1, title: 'PIVOT', visible: true });
const resistance1Series = mainChart.addSeries(LightweightCharts.LineSeries, { color: '#f53f3f', lineWidth: 1, title: '阻力1', visible: true });
const resistance2Series = mainChart.addSeries(LightweightCharts.LineSeries, { color: '#fa8c16', lineWidth: 1, title: '阻力2', visible: true });
const support1Series = mainChart.addSeries(LightweightCharts.LineSeries, { color: '#52c41a', lineWidth: 1, title: '支撑1', visible: true });
const support2Series = mainChart.addSeries(LightweightCharts.LineSeries, { color: '#13c2c2', lineWidth: 1, title: '支撑2', visible: true });
const dcHigh20Series = mainChart.addSeries(LightweightCharts.LineSeries, { color: '#faad14', lineWidth: 1, title: '唐奇安上轨', visible: false });
const dcLow20Series = mainChart.addSeries(LightweightCharts.LineSeries, { color: '#13c2c2', lineWidth: 1, title: '唐奇安下轨', visible: false });

// 初始化其他图表
const volumeChart = LightweightCharts.createChart(document.getElementById('volumeChart'), { 
    width: getChartWidth(), 
    height: 100,
    layout: { textColor: '#333' },
    grid: { visible: false },
    timeScale: { 
        timeVisible: true,
        secondsVisible: false,
        borderColor: '#d1d1d1',
        fixLeftEdge: true,
        fixRightEdge: true,
        barSpacing: 6,
        minBarSpacing: 3,
    },
});
const volumeSeries = volumeChart.addSeries(LightweightCharts.HistogramSeries, { 
    color: '#f53f3f', 
    priceFormat: { type: 'volume' } 
});

const macdChart = LightweightCharts.createChart(document.getElementById('macdChart'), { 
    width: getChartWidth(), 
    height: 100,
    layout: { textColor: '#333' },
    grid: { visible: false },
    timeScale: { 
        timeVisible: true,
        secondsVisible: false,
        borderColor: '#d1d1d1',
        fixLeftEdge: true,
        fixRightEdge: true,
        barSpacing: 6,
        minBarSpacing: 3,
    },
});
const macdHistogramSeries = macdChart.addSeries(LightweightCharts.HistogramSeries, { color: '#52c41a', priceFormat: { type: 'price' } });
const macdDiffSeries = macdChart.addSeries(LightweightCharts.LineSeries, { color: '#722ed1', lineWidth: 2, title: 'DIF' });
const macdSignalSeries = macdChart.addSeries(LightweightCharts.LineSeries, { color: '#fa8c16', lineWidth: 2, title: 'DEA' });

const rsiChart = LightweightCharts.createChart(document.getElementById('rsiChart'), { 
    width: getChartWidth(), 
    height: 100,
    layout: { textColor: '#333' },
    grid: { visible: false },
    timeScale: { 
        timeVisible: true,
        secondsVisible: false,
        borderColor: '#d1d1d1',
        fixLeftEdge: true,
        fixRightEdge: true,
        barSpacing: 6,
        minBarSpacing: 3,
    },
});
const stochRsiKSeries = rsiChart.addSeries(LightweightCharts.LineSeries, { color: 'blue', lineWidth: 1, title: 'Stoch RSI K' });
const stochRsiDSeries = rsiChart.addSeries(LightweightCharts.LineSeries, { color: 'red', lineWidth: 1, title: 'Stoch RSI D' });

// 初始化SKDJ图表
const skdjChart = LightweightCharts.createChart(document.getElementById('skdjChart'), {
    width: getChartWidth(),
    height: 100,
    layout: { textColor: '#333' },
    grid: { visible: false },
    timeScale: {
        timeVisible: true,
        secondsVisible: false,
        borderColor: '#d1d1d1',
        fixLeftEdge: true,
        fixRightEdge: true,
        barSpacing: 6,
        minBarSpacing: 3,
    },
});
const skdjKSeries = skdjChart.addSeries(LightweightCharts.LineSeries, { color: '#1890ff', lineWidth: 1, title: 'SKDJ K' });
const skdjDSeries = skdjChart.addSeries(LightweightCharts.LineSeries, { color: '#fa8c16', lineWidth: 1, title: 'SKDJ D' });

// 初始化MK共振图表
const mkChart = LightweightCharts.createChart(document.getElementById('mkChart'), {
    width: getChartWidth(),
    height: 100,
    layout: { textColor: '#333' },
    grid: { visible: false },
    timeScale: {
        timeVisible: true,
        secondsVisible: false,
        borderColor: '#d1d1d1',
        fixLeftEdge: true,
        fixRightEdge: true,
        barSpacing: 6,
        minBarSpacing: 3,
    },
});
const mkSeries = mkChart.addSeries(LightweightCharts.HistogramSeries, { color: '#52c41a', priceFormat: { type: 'price' } });

// 初始化策略信号图表
const strategyChart = LightweightCharts.createChart(document.getElementById('strategyChart'), {
    width: getChartWidth(),
    height: 100,
    layout: { textColor: '#333' },
    grid: { visible: false },
    timeScale: {
        timeVisible: true,
        secondsVisible: false,
        borderColor: '#d1d1d1',
        fixLeftEdge: true,
        fixRightEdge: true,
        barSpacing: 6,
        minBarSpacing: 3,
    },
});
const td9Series = strategyChart.addSeries(LightweightCharts.LineSeries, { color: '#722ed1', lineWidth: 2, title: 'TD9信号' });
const emaStrategySeries = strategyChart.addSeries(LightweightCharts.LineSeries, { color: '#13c2c2', lineWidth: 2, title: 'EMA策略' });
const superBandSeries = strategyChart.addSeries(LightweightCharts.LineSeries, { color: '#faad14', lineWidth: 2, title: '超级波段' });

// 初始化OBV图表
const obvChart = LightweightCharts.createChart(document.getElementById('obvChart'), {
    width: getChartWidth(),
    height: 100,
    layout: { textColor: '#333' },
    grid: { visible: false },
    timeScale: {
        timeVisible: true,
        secondsVisible: false,
        borderColor: '#d1d1d1',
        fixLeftEdge: true,
        fixRightEdge: true,
        barSpacing: 6,
        minBarSpacing: 3,
    },
});
const obvSeries = obvChart.addSeries(LightweightCharts.LineSeries, { color: '#1890ff', lineWidth: 2, title: 'OBV' });

// 初始化MFI图表
const mfiChart = LightweightCharts.createChart(document.getElementById('mfiChart'), {
    width: getChartWidth(),
    height: 100,
    layout: { textColor: '#333' },
    grid: { visible: false },
    timeScale: {
        timeVisible: true,
        secondsVisible: false,
        borderColor: '#d1d1d1',
        fixLeftEdge: true,
        fixRightEdge: true,
        barSpacing: 6,
        minBarSpacing: 3,
    },
});
const mfiSeries = mfiChart.addSeries(LightweightCharts.LineSeries, { color: '#fa8c16', lineWidth: 2, title: 'MFI14' });

// 初始化CCI图表
const cciChart = LightweightCharts.createChart(document.getElementById('cciChart'), {
    width: getChartWidth(),
    height: 100,
    layout: { textColor: '#333' },
    grid: { visible: false },
    timeScale: {
        timeVisible: true,
        secondsVisible: false,
        borderColor: '#d1d1d1',
        fixLeftEdge: true,
        fixRightEdge: true,
        barSpacing: 6,
        minBarSpacing: 3,
    },
});
const cci20Series = cciChart.addSeries(LightweightCharts.LineSeries, { color: '#1890ff', lineWidth: 1, title: 'CCI20' });
const cci14Series = cciChart.addSeries(LightweightCharts.LineSeries, { color: '#fa8c16', lineWidth: 1, title: 'CCI14' });

// 初始化ROC图表
const rocChart = LightweightCharts.createChart(document.getElementById('rocChart'), {
    width: getChartWidth(),
    height: 100,
    layout: { textColor: '#333' },
    grid: { visible: false },
    timeScale: {
        timeVisible: true,
        secondsVisible: false,
        borderColor: '#d1d1d1',
        fixLeftEdge: true,
        fixRightEdge: true,
        barSpacing: 6,
        minBarSpacing: 3,
    },
});
const roc10Series = rocChart.addSeries(LightweightCharts.LineSeries, { color: '#722ed1', lineWidth: 1, title: 'ROC10' });
const roc20Series = rocChart.addSeries(LightweightCharts.LineSeries, { color: '#13c2c2', lineWidth: 1, title: 'ROC20' });

// 初始化William %R图表
const williamsChart = LightweightCharts.createChart(document.getElementById('williamsChart'), {
    width: getChartWidth(),
    height: 100,
    layout: { textColor: '#333' },
    grid: { visible: false },
    timeScale: {
        timeVisible: true,
        secondsVisible: false,
        borderColor: '#d1d1d1',
        fixLeftEdge: true,
        fixRightEdge: true,
        barSpacing: 6,
        minBarSpacing: 3,
    },
});
const williamsR14Series = williamsChart.addSeries(LightweightCharts.LineSeries, { color: '#eb2f96', lineWidth: 1, title: 'William %R14' });

// 初始化KDJ图表
const kdjChart = LightweightCharts.createChart(document.getElementById('kdjChart'), {
    width: getChartWidth(),
    height: 100,
    layout: { textColor: '#333' },
    grid: { visible: false },
    timeScale: {
        timeVisible: true,
        secondsVisible: false,
        borderColor: '#d1d1d1',
        fixLeftEdge: true,
        fixRightEdge: true,
        barSpacing: 6,
        minBarSpacing: 3,
    },
});
const kdjKSeries = kdjChart.addSeries(LightweightCharts.LineSeries, { color: '#1890ff', lineWidth: 1, title: 'KDJ K' });
const kdjDSeries = kdjChart.addSeries(LightweightCharts.LineSeries, { color: '#fa8c16', lineWidth: 1, title: 'KDJ D' });
const kdjJSeries = kdjChart.addSeries(LightweightCharts.LineSeries, { color: '#f53f3f', lineWidth: 1, title: 'KDJ J' });

// 初始化TRIX图表
const trixChart = LightweightCharts.createChart(document.getElementById('trixChart'), {
    width: getChartWidth(),
    height: 100,
    layout: { textColor: '#333' },
    grid: { visible: false },
    timeScale: {
        timeVisible: true,
        secondsVisible: false,
        borderColor: '#d1d1d1',
        fixLeftEdge: true,
        fixRightEdge: true,
        barSpacing: 6,
        minBarSpacing: 3,
    },
});
const trixSeries = trixChart.addSeries(LightweightCharts.LineSeries, { color: '#722ed1', lineWidth: 2, title: 'TRIX' });
const trixSignalSeries = trixChart.addSeries(LightweightCharts.LineSeries, { color: '#fa8c16', lineWidth: 1, title: 'TRIX信号线' });

// 初始化BBI图表
const bbiChart = LightweightCharts.createChart(document.getElementById('bbiChart'), {
    width: getChartWidth(),
    height: 100,
    layout: { textColor: '#333' },
    grid: { visible: false },
    timeScale: {
        timeVisible: true,
        secondsVisible: false,
        borderColor: '#d1d1d1',
        fixLeftEdge: true,
        fixRightEdge: true,
        barSpacing: 6,
        minBarSpacing: 3,
    },
});
const bbiSeries = bbiChart.addSeries(LightweightCharts.LineSeries, { color: '#13c2c2', lineWidth: 2, title: 'BBI' });



// 全局变量存储当前K线数据
let currentKlineData = [];

// 显示浮动信息标签
function showCrosshairInfo(x, y, data) {
    const crosshairInfo = document.getElementById('crosshairInfo');
    if (!crosshairInfo || !data) return;
    
    // 调试：打印接收到的数据
    console.log('浮动信息标签数据:', data);
    
    // 更新信息内容
    document.getElementById('crosshairDate').textContent = data.date || '--';
    document.getElementById('crosshairOpen').textContent = data.open ? data.open.toFixed(2) : '--';
    document.getElementById('crosshairHigh').textContent = data.high ? data.high.toFixed(2) : '--';
    document.getElementById('crosshairLow').textContent = data.low ? data.low.toFixed(2) : '--';
    document.getElementById('crosshairClose').textContent = data.close ? data.close.toFixed(2) : '--';
    
    // 计算涨幅（正确的计算方式：使用昨收价作为基准）
    let changePercent = '--';
    let changeClass = '';
    if (data.close && data.prev_close) {
        // 正确的涨幅计算：收盘价相对于昨收价的涨跌幅
        const change = ((data.close - data.prev_close) / data.prev_close * 100);
        changePercent = (change >= 0 ? '+' : '') + change.toFixed(2) + '%';
        changeClass = change >= 0 ? 'increase' : 'decrease';
        
        // 调试：打印涨幅计算数据
        console.log('昨收价:', data.prev_close, '收盘价:', data.close, '涨幅:', changePercent);
    }
    document.getElementById('crosshairChange').textContent = changePercent;
    document.getElementById('crosshairChange').className = 'info-value ' + changeClass;
    
    // 格式化成交量
    let volumeDisplay = '--';
    if (data.volume) {
        // 成交量需要除以100（因为后端返回的是股数，需要转换为手数）
        const volume = parseFloat(data.volume) / 100;
        // 调试：打印原始成交量数据
        console.log('原始成交量:', data.volume, '除以100后:', volume);
        
        // 正确的单位转换：1亿=100000000，1万=10000
        if (volume >= 100000000) {
            volumeDisplay = (volume / 100000000).toFixed(2) + '亿';
        } else if (volume >= 10000) {
            volumeDisplay = (volume / 10000).toFixed(2) + '万';
        } else {
            volumeDisplay = volume.toLocaleString();
        }
        
        // 调试：打印格式化后的成交量
        console.log('格式化成交量:', volumeDisplay);
    }
    document.getElementById('crosshairVolume').textContent = volumeDisplay;
    
    // 格式化成交额（使用后端返回的turnover字段）
    let amountDisplay = '--';
    if (data.turnover) {
        const amount = parseFloat(data.turnover);
        if (amount >= 100000000) {
            amountDisplay = (amount / 100000000).toFixed(2) + '亿';
        } else if (amount >= 10000) {
            amountDisplay = (amount / 10000).toFixed(2) + '万';
        } else {
            amountDisplay = amount.toLocaleString();
        }
    }
    document.getElementById('crosshairAmount').textContent = amountDisplay;
    
    // 格式化换手率（使用后端返回的turnover_rate字段）
    let turnoverRateDisplay = '--';
    if (data.turnover_rate) {
        turnoverRateDisplay = data.turnover_rate.toFixed(2) + '%';
    }
    document.getElementById('crosshairTurnover').textContent = turnoverRateDisplay;

    
    // 显示标签并定位
    crosshairInfo.style.display = 'block';
    
    // 计算位置，避免超出屏幕边界
    const chartRect = document.getElementById('mainChart').getBoundingClientRect();
    const infoRect = crosshairInfo.getBoundingClientRect();
    
    let posX = x + 10;
    let posY = y + 10;
    
    // 检查右侧边界
    if (posX + infoRect.width > chartRect.right) {
        posX = x - infoRect.width - 10;
    }
    
    // 检查底部边界
    if (posY + infoRect.height > chartRect.bottom) {
        posY = y - infoRect.height - 10;
    }
    
    crosshairInfo.style.left = (posX - chartRect.left) + 'px';
    crosshairInfo.style.top = (posY - chartRect.top) + 'px';
}

// 隐藏浮动信息标签
function hideCrosshairInfo() {
    const crosshairInfo = document.getElementById('crosshairInfo');
    if (crosshairInfo) {
        crosshairInfo.style.display = 'none';
    }
}

// 根据鼠标位置查找对应的K线数据
function findKlineDataAtPosition(logicalX) {
    if (!currentKlineData.length) return null;
    
    // 获取时间轴范围
    const timeScale = mainChart.timeScale();
    const visibleRange = timeScale.getVisibleLogicalRange();
    if (!visibleRange) return null;
    
    const { from, to } = visibleRange;
    
    // 计算当前逻辑位置对应的数据索引
    // 逻辑坐标从0开始（最左边，时间最早），对应数据数组的第一个元素
    // 逻辑坐标越大（向右移动），对应数据数组的索引越大（时间越新）
    const dataIndex = Math.max(0, Math.min(currentKlineData.length - 1, Math.round(logicalX)));
    
    if (dataIndex >= 0 && dataIndex < currentKlineData.length) {
        return currentKlineData[dataIndex];
    }
    
    return null;
}

// 设置主图鼠标事件
function setupMainChartMouseEvents() {
    const chartContainer = document.getElementById('mainChart');
    if (!chartContainer) return;
    
    // 鼠标移动事件
    chartContainer.addEventListener('mousemove', (e) => {
        const rect = chartContainer.getBoundingClientRect();
        const mouseX = e.clientX - rect.left;
        const mouseY = e.clientY - rect.top;
        
        // 将鼠标坐标转换为逻辑坐标
        const timeScale = mainChart.timeScale();
        const logicalX = timeScale.coordinateToLogical(mouseX);
        
        if (logicalX !== null) {
            const data = findKlineDataAtPosition(logicalX);
            if (data) {
                showCrosshairInfo(e.clientX, e.clientY, data);
            } else {
                hideCrosshairInfo();
            }
        } else {
            hideCrosshairInfo();
        }
    });
    
    // 鼠标离开图表区域时隐藏信息标签
    chartContainer.addEventListener('mouseleave', () => {
        hideCrosshairInfo();
    });
    
    // 点击图表时也隐藏信息标签（避免遮挡）
    chartContainer.addEventListener('click', () => {
        hideCrosshairInfo();
    });
}

// 请求 K线数据
async function loadKline(symbol) {
    try {
        // 显示加载状态
        showLoading();
        
        // 为当前选中的股票添加loading样式
        if (selectedStockCode) {
            const rows = document.querySelectorAll('#watchlistTable tbody tr');
            rows.forEach(row => {
                const codeCell = row.cells[0];
                if (codeCell && codeCell.textContent === selectedStockCode.replace(/^(sh|sz)/i, '')) {
                    $(row).addClass('loading');
                }
            });
        }
        
        // 处理股票代码
        const processedSymbol = processStockCode(symbol);
        
        // 获取股票基本信息
        const stockInfoRes = await fetch(`http://127.0.0.1:8000/api/stock_info?symbol=${processedSymbol}`);
        const stockInfoJson = await stockInfoRes.json();
        
        if (stockInfoRes.ok) {
            const stockInfo = stockInfoJson.data;
            // 更新标题区域
            document.getElementById('stockName').textContent = stockInfo.name;
            document.getElementById('stockCode').textContent = processedSymbol;
        }
        
        const res = await fetch(`http://127.0.0.1:8000/api/kline?symbol=${processedSymbol}&period=daily&limit=500&include_realtime=true`);
        const json = await res.json();
        const data = json.data;
        
        // 保存当前K线数据到全局变量
        currentKlineData = data;

        // 设置蜡烛图数据 - 红涨绿跌
        candleSeries.setData(data.map(item => ({
            time: item.date, 
            open: item.open, 
            high: item.high, 
            low: item.low, 
            close: item.close 
        })));
        
        // 设置成交量数据 - 红涨绿跌
        volumeSeries.setData(data.map(item => ({
            time: item.date, 
            value: item.volume, 
            color: item.close >= item.open ? '#f53f3f' : '#00b42a' 
        })));
        
        // 设置MACD数据 - 红绿实心/空心柱状图
        const macdHistogramData = data.map((item, index) => {
            let color, value = item.macd_hist;

            // 设置红绿实心/空心样式
            if (value >= 0) {
                // MACD柱状图在0轴以上，显示为红色实心
                color = '#f53f3f';
            } else {
                // MACD柱状图在0轴以下，显示为绿色实心
                color = '#00b42a';
            }

            return { time: item.date, value, color };
        });

        // 设置DIF和DEA双曲线
        macdHistogramSeries.setData(macdHistogramData);

        // 设置DIF和DEA数据，并添加金叉死叉标记
        const diffData = [];
        const signalData = [];
        const markers = [];

        data.forEach((item, index) => {
            const time = item.date;
            const diffValue = item.macd_diff;
            const signalValue = item.macd_signal;

            diffData.push({ time, value: diffValue });
            signalData.push({ time, value: signalValue });

            // 检查金叉死叉
            if (index > 0) {
                const prevDiff = data[index - 1].macd_diff;
                const prevSignal = data[index - 1].macd_signal;

                // 金叉：DIF上穿DEA
                if (diffValue > signalValue && prevDiff <= prevSignal) {
                    markers.push({
                        time,
                        position: 'belowBar',
                        color: '#52c41a',
                        shape: 'circle',
                        size: 2,
                        text: '金叉',
                    });
                }
                // 死叉：DIF下穿DEA
                else if (diffValue < signalValue && prevDiff >= prevSignal) {
                    markers.push({
                        time,
                        position: 'aboveBar',
                        color: '#f53f3f',
                        shape: 'circle',
                        size: 2,
                        text: '死叉',
                    });
                }
            }
        });

        macdDiffSeries.setData(diffData);
        macdSignalSeries.setData(signalData);

        // MACD线图本身不支持标记，跳过标记功能
        // macdDiffSeries.setMarkers(markers);
        
        // 设置主图指标数据
        bbUpperSeries.setData(data.map(item => ({ time: item.date, value: item.bb_upper })));
        bbLowerSeries.setData(data.map(item => ({ time: item.date, value: item.bb_lower })));
        supertrendSeries.setData(data.map(item => ({ time: item.date, value: item.supertrend })));
        ma14Series.setData(data.map(item => ({ time: item.date, value: item.ma14 })));
        ma21Series.setData(data.map(item => ({ time: item.date, value: item.ma21 })));
        ma35Series.setData(data.map(item => ({ time: item.date, value: item.ma35 })));
        ma50Series.setData(data.map(item => ({ time: item.date, value: item.ma50 })));
        ma100Series.setData(data.map(item => ({ time: item.date, value: item.ma100 })));
        ma200Series.setData(data.map(item => ({ time: item.date, value: item.ma200 })));
        
        // 设置Stoch RSI数据
        stochRsiKSeries.setData(data.map(item => ({ time: item.date, value: item.stoch_rsi_k })));
        stochRsiDSeries.setData(data.map(item => ({ time: item.date, value: item.stoch_rsi_d })));

        // 设置SKDJ数据
        skdjKSeries.setData(data.map(item => ({ time: item.date, value: item.skdj_k })));
        skdjDSeries.setData(data.map(item => ({ time: item.date, value: item.skdj_d })));

        // 设置MK共振数据 - 使用后端计算的MK共振信号
        const mkData = data.map((item, index) => {
            let mkValue = item.mk_resonance || 0;
            let mkColor = '#d9d9d9'; // 默认灰色

            if (mkValue === 2) {
                mkColor = '#52c41a'; // 强买入绿色
                mkValue = 2;
            } else if (mkValue === 1) {
                mkColor = '#95de64'; // 弱买入浅绿
                mkValue = 1;
            } else if (mkValue === -2) {
                mkColor = '#f53f3f'; // 强卖出红色
                mkValue = -2;
            } else if (mkValue === -1) {
                mkColor = '#ff7875'; // 弱卖出浅红
                mkValue = -1;
            }

            return { time: item.date, value: mkValue, color: mkColor };
        });
        mkSeries.setData(mkData);

        // 设置策略信号数据 - 确保数据存在时才设置
        if (data && data.length > 0) {
            console.log('检查数据字段:', Object.keys(data[0] || {}));

            const td9Data = data.map(item => ({ time: item.date, value: (item.td9_signal || 0) * 50 }));
            const emaData = data.map(item => ({ time: item.date, value: (item.ema_signal || 0) * 50 }));
            const superBandData = data.map(item => ({ time: item.date, value: (item.super_band_signal || 0) * 50 }));

            console.log('策略数据:', {
                td9Data: td9Data.filter(d => d.value !== 0),
                emaData: emaData.filter(d => d.value !== 0),
                superBandData: superBandData.filter(d => d.value !== 0)
            });

            // 只有当图表系列存在时才设置数据
            if (td9Series && emaStrategySeries && superBandSeries) {
                td9Series.setData(td9Data);
                emaStrategySeries.setData(emaData);
                superBandSeries.setData(superBandData);
            }
        }
        
        // 设置OBV数据
        obvSeries.setData(data.map(item => ({
            time: item.date,
            value: item.obv || 0
        })));
        
        // 设置MFI数据
        mfiSeries.setData(data.map(item => ({
            time: item.date,
            value: item.mfi14 || 0
        })));
        
        // 设置CCI数据
        cci20Series.setData(data.map(item => ({
            time: item.date,
            value: item.cci20 || 0
        })));
        cci14Series.setData(data.map(item => ({
            time: item.date,
            value: item.cci14 || 0
        })));
        
        // 设置ROC数据
        roc10Series.setData(data.map(item => ({
            time: item.date,
            value: item.roc10 || 0
        })));
        roc20Series.setData(data.map(item => ({
            time: item.date,
            value: item.roc20 || 0
        })));
        
        // 设置William %R数据
        williamsR14Series.setData(data.map(item => ({
            time: item.date,
            value: item.williams_r14 || 0
        })));
        
        // 设置KDJ数据
        kdjKSeries.setData(data.map(item => ({
            time: item.date,
            value: item.kdj_k || 0
        })));
        kdjDSeries.setData(data.map(item => ({
            time: item.date,
            value: item.kdj_d || 0
        })));
        kdjJSeries.setData(data.map(item => ({
            time: item.date,
            value: item.kdj_j || 0
        })));
        
        // 设置TRIX数据
        trixSeries.setData(data.map(item => ({
            time: item.date,
            value: item.trix || 0
        })));
        trixSignalSeries.setData(data.map(item => ({
            time: item.date,
            value: item.trix_signal || 0
        })));
        
        // 设置BBI数据
        bbiSeries.setData(data.map(item => ({
            time: item.date,
            value: item.bbi || 0
        })));
        

        
        // 设置新指标数据
        zigzag5Series.setData(data.map(item => ({
            time: item.date,
            value: item.zigzag_5 || 0
        })));
        zigzag7Series.setData(data.map(item => ({
            time: item.date,
            value: item.zigzag_7 || 0
        })));
        
        // 设置PIVOT枢轴点数据 - 过滤掉None值
        const pivotData = data.map(item => ({
            time: item.date,
            value: item.pivot
        })).filter(item => item.value !== null && item.value !== undefined && item.value !== 0);
        pivotSeries.setData(pivotData);
        
        const resistance1Data = data.map(item => ({
            time: item.date,
            value: item.resistance1
        })).filter(item => item.value !== null && item.value !== undefined && item.value !== 0);
        resistance1Series.setData(resistance1Data);
        
        const resistance2Data = data.map(item => ({
            time: item.date,
            value: item.resistance2
        })).filter(item => item.value !== null && item.value !== undefined && item.value !== 0);
        resistance2Series.setData(resistance2Data);
        
        const support1Data = data.map(item => ({
            time: item.date,
            value: item.support1
        })).filter(item => item.value !== null && item.value !== undefined && item.value !== 0);
        support1Series.setData(support1Data);
        
        const support2Data = data.map(item => ({
            time: item.date,
            value: item.support2
        })).filter(item => item.value !== null && item.value !== undefined && item.value !== 0);
        support2Series.setData(support2Data);
        
        dcHigh20Series.setData(data.map(item => ({
            time: item.date,
            value: item.dc_high20 || 0
        })));
        dcLow20Series.setData(data.map(item => ({
            time: item.date,
            value: item.dc_low20 || 0
        })));
        
        // 同步所有图表的时间轴
        const allCharts = [mainChart, volumeChart, macdChart, rsiChart, skdjChart, mkChart, strategyChart, obvChart, mfiChart, cciChart, rocChart, williamsChart, kdjChart, trixChart, bbiChart];
        allCharts.forEach(chart => {
            if (chart && chart.timeScale) {
                chart.timeScale().scrollToPosition(0, true);
            }
        });
        
        // 设置所有附图的时间轴与主图同步
        volumeChart.timeScale().applyOptions({
            timeVisible: true,
            secondsVisible: false,
        });
        macdChart.timeScale().applyOptions({
            timeVisible: true,
            secondsVisible: false,
        });
        rsiChart.timeScale().applyOptions({
            timeVisible: true,
            secondsVisible: false,
        });
        skdjChart.timeScale().applyOptions({
            timeVisible: true,
            secondsVisible: false,
        });
        mkChart.timeScale().applyOptions({
            timeVisible: true,
            secondsVisible: false,
        });
        strategyChart.timeScale().applyOptions({
            timeVisible: true,
            secondsVisible: false,
        });
        obvChart.timeScale().applyOptions({
            timeVisible: true,
            secondsVisible: false,
        });
        mfiChart.timeScale().applyOptions({
            timeVisible: true,
            secondsVisible: false,
        });
        cciChart.timeScale().applyOptions({
            timeVisible: true,
            secondsVisible: false,
        });
        rocChart.timeScale().applyOptions({
            timeVisible: true,
            secondsVisible: false,
        });
        williamsChart.timeScale().applyOptions({
            timeVisible: true,
            secondsVisible: false,
        });
        
        kdjChart.timeScale().applyOptions({
            timeVisible: true,
            secondsVisible: false,
        });
        
        trixChart.timeScale().applyOptions({
            timeVisible: true,
            secondsVisible: false,
        });
        
        bbiChart.timeScale().applyOptions({
            timeVisible: true,
            secondsVisible: false,
        });
        

        
        // 同步可见区域 - 双向联动
        mainChart.timeScale().subscribeVisibleTimeRangeChange((range) => {
            volumeChart.timeScale().setVisibleRange(range);
            macdChart.timeScale().setVisibleRange(range);
            rsiChart.timeScale().setVisibleRange(range);
            skdjChart.timeScale().setVisibleRange(range);
            mkChart.timeScale().setVisibleRange(range);
            strategyChart.timeScale().setVisibleRange(range);
            obvChart.timeScale().setVisibleRange(range);
            mfiChart.timeScale().setVisibleRange(range);
            cciChart.timeScale().setVisibleRange(range);
            rocChart.timeScale().setVisibleRange(range);
            williamsChart.timeScale().setVisibleRange(range);
            kdjChart.timeScale().setVisibleRange(range);
            trixChart.timeScale().setVisibleRange(range);
            bbiChart.timeScale().setVisibleRange(range);

        });
        
        // 附图时间轴变化时也同步到主图
        volumeChart.timeScale().subscribeVisibleTimeRangeChange((range) => {
            mainChart.timeScale().setVisibleRange(range);
            macdChart.timeScale().setVisibleRange(range);
            rsiChart.timeScale().setVisibleRange(range);
            skdjChart.timeScale().setVisibleRange(range);
            mkChart.timeScale().setVisibleRange(range);
            strategyChart.timeScale().setVisibleRange(range);
            obvChart.timeScale().setVisibleRange(range);
            mfiChart.timeScale().setVisibleRange(range);
            cciChart.timeScale().setVisibleRange(range);
            rocChart.timeScale().setVisibleRange(range);
            williamsChart.timeScale().setVisibleRange(range);
            kdjChart.timeScale().setVisibleRange(range);
            trixChart.timeScale().setVisibleRange(range);
            bbiChart.timeScale().setVisibleRange(range);
        });

        macdChart.timeScale().subscribeVisibleTimeRangeChange((range) => {
            mainChart.timeScale().setVisibleRange(range);
            volumeChart.timeScale().setVisibleRange(range);
            rsiChart.timeScale().setVisibleRange(range);
            skdjChart.timeScale().setVisibleRange(range);
            mkChart.timeScale().setVisibleRange(range);
            strategyChart.timeScale().setVisibleRange(range);
            obvChart.timeScale().setVisibleRange(range);
            mfiChart.timeScale().setVisibleRange(range);
            cciChart.timeScale().setVisibleRange(range);
            rocChart.timeScale().setVisibleRange(range);
            williamsChart.timeScale().setVisibleRange(range);
            kdjChart.timeScale().setVisibleRange(range);
            trixChart.timeScale().setVisibleRange(range);
            bbiChart.timeScale().setVisibleRange(range);
        });

        rsiChart.timeScale().subscribeVisibleTimeRangeChange((range) => {
            mainChart.timeScale().setVisibleRange(range);
            volumeChart.timeScale().setVisibleRange(range);
            macdChart.timeScale().setVisibleRange(range);
            skdjChart.timeScale().setVisibleRange(range);
            mkChart.timeScale().setVisibleRange(range);
            strategyChart.timeScale().setVisibleRange(range);
            obvChart.timeScale().setVisibleRange(range);
            mfiChart.timeScale().setVisibleRange(range);
            cciChart.timeScale().setVisibleRange(range);
            rocChart.timeScale().setVisibleRange(range);
            williamsChart.timeScale().setVisibleRange(range);
            kdjChart.timeScale().setVisibleRange(range);
            trixChart.timeScale().setVisibleRange(range);
            bbiChart.timeScale().setVisibleRange(range);
        });

        skdjChart.timeScale().subscribeVisibleTimeRangeChange((range) => {
            mainChart.timeScale().setVisibleRange(range);
            volumeChart.timeScale().setVisibleRange(range);
            macdChart.timeScale().setVisibleRange(range);
            rsiChart.timeScale().setVisibleRange(range);
            mkChart.timeScale().setVisibleRange(range);
            strategyChart.timeScale().setVisibleRange(range);
            obvChart.timeScale().setVisibleRange(range);
            mfiChart.timeScale().setVisibleRange(range);
            cciChart.timeScale().setVisibleRange(range);
            rocChart.timeScale().setVisibleRange(range);
            williamsChart.timeScale().setVisibleRange(range);
            kdjChart.timeScale().setVisibleRange(range);
            trixChart.timeScale().setVisibleRange(range);
            bbiChart.timeScale().setVisibleRange(range);
        });

        mkChart.timeScale().subscribeVisibleTimeRangeChange((range) => {
            mainChart.timeScale().setVisibleRange(range);
            volumeChart.timeScale().setVisibleRange(range);
            macdChart.timeScale().setVisibleRange(range);
            rsiChart.timeScale().setVisibleRange(range);
            skdjChart.timeScale().setVisibleRange(range);
            strategyChart.timeScale().setVisibleRange(range);
            obvChart.timeScale().setVisibleRange(range);
            mfiChart.timeScale().setVisibleRange(range);
            cciChart.timeScale().setVisibleRange(range);
            rocChart.timeScale().setVisibleRange(range);
            williamsChart.timeScale().setVisibleRange(range);
            kdjChart.timeScale().setVisibleRange(range);
            trixChart.timeScale().setVisibleRange(range);
            bbiChart.timeScale().setVisibleRange(range);
        });

        strategyChart.timeScale().subscribeVisibleTimeRangeChange((range) => {
            mainChart.timeScale().setVisibleRange(range);
            volumeChart.timeScale().setVisibleRange(range);
            macdChart.timeScale().setVisibleRange(range);
            rsiChart.timeScale().setVisibleRange(range);
            skdjChart.timeScale().setVisibleRange(range);
            mkChart.timeScale().setVisibleRange(range);
            obvChart.timeScale().setVisibleRange(range);
            mfiChart.timeScale().setVisibleRange(range);
            cciChart.timeScale().setVisibleRange(range);
            rocChart.timeScale().setVisibleRange(range);
            williamsChart.timeScale().setVisibleRange(range);
            kdjChart.timeScale().setVisibleRange(range);
            trixChart.timeScale().setVisibleRange(range);
            bbiChart.timeScale().setVisibleRange(range);
        });

        obvChart.timeScale().subscribeVisibleTimeRangeChange((range) => {
            mainChart.timeScale().setVisibleRange(range);
            volumeChart.timeScale().setVisibleRange(range);
            macdChart.timeScale().setVisibleRange(range);
            rsiChart.timeScale().setVisibleRange(range);
            skdjChart.timeScale().setVisibleRange(range);
            mkChart.timeScale().setVisibleRange(range);
            strategyChart.timeScale().setVisibleRange(range);
            mfiChart.timeScale().setVisibleRange(range);
            cciChart.timeScale().setVisibleRange(range);
            rocChart.timeScale().setVisibleRange(range);
            williamsChart.timeScale().setVisibleRange(range);
            kdjChart.timeScale().setVisibleRange(range);
            trixChart.timeScale().setVisibleRange(range);
            bbiChart.timeScale().setVisibleRange(range);
        });

        mfiChart.timeScale().subscribeVisibleTimeRangeChange((range) => {
            mainChart.timeScale().setVisibleRange(range);
            volumeChart.timeScale().setVisibleRange(range);
            macdChart.timeScale().setVisibleRange(range);
            rsiChart.timeScale().setVisibleRange(range);
            skdjChart.timeScale().setVisibleRange(range);
            mkChart.timeScale().setVisibleRange(range);
            strategyChart.timeScale().setVisibleRange(range);
            obvChart.timeScale().setVisibleRange(range);
            cciChart.timeScale().setVisibleRange(range);
            rocChart.timeScale().setVisibleRange(range);
            williamsChart.timeScale().setVisibleRange(range);
            kdjChart.timeScale().setVisibleRange(range);
            trixChart.timeScale().setVisibleRange(range);
            bbiChart.timeScale().setVisibleRange(range);
        });

        cciChart.timeScale().subscribeVisibleTimeRangeChange((range) => {
            mainChart.timeScale().setVisibleRange(range);
            volumeChart.timeScale().setVisibleRange(range);
            macdChart.timeScale().setVisibleRange(range);
            rsiChart.timeScale().setVisibleRange(range);
            skdjChart.timeScale().setVisibleRange(range);
            mkChart.timeScale().setVisibleRange(range);
            strategyChart.timeScale().setVisibleRange(range);
            obvChart.timeScale().setVisibleRange(range);
            mfiChart.timeScale().setVisibleRange(range);
            rocChart.timeScale().setVisibleRange(range);
            williamsChart.timeScale().setVisibleRange(range);
            kdjChart.timeScale().setVisibleRange(range);
            trixChart.timeScale().setVisibleRange(range);
            bbiChart.timeScale().setVisibleRange(range);
        });

        rocChart.timeScale().subscribeVisibleTimeRangeChange((range) => {
            mainChart.timeScale().setVisibleRange(range);
            volumeChart.timeScale().setVisibleRange(range);
            macdChart.timeScale().setVisibleRange(range);
            rsiChart.timeScale().setVisibleRange(range);
            skdjChart.timeScale().setVisibleRange(range);
            mkChart.timeScale().setVisibleRange(range);
            strategyChart.timeScale().setVisibleRange(range);
            obvChart.timeScale().setVisibleRange(range);
            mfiChart.timeScale().setVisibleRange(range);
            cciChart.timeScale().setVisibleRange(range);
            williamsChart.timeScale().setVisibleRange(range);
            kdjChart.timeScale().setVisibleRange(range);
            trixChart.timeScale().setVisibleRange(range);
            bbiChart.timeScale().setVisibleRange(range);
        });

        williamsChart.timeScale().subscribeVisibleTimeRangeChange((range) => {
            mainChart.timeScale().setVisibleRange(range);
            volumeChart.timeScale().setVisibleRange(range);
            macdChart.timeScale().setVisibleRange(range);
            rsiChart.timeScale().setVisibleRange(range);
            skdjChart.timeScale().setVisibleRange(range);
            mkChart.timeScale().setVisibleRange(range);
            strategyChart.timeScale().setVisibleRange(range);
            obvChart.timeScale().setVisibleRange(range);
            mfiChart.timeScale().setVisibleRange(range);
            cciChart.timeScale().setVisibleRange(range);
            rocChart.timeScale().setVisibleRange(range);
            kdjChart.timeScale().setVisibleRange(range);
            trixChart.timeScale().setVisibleRange(range);
            bbiChart.timeScale().setVisibleRange(range);
        });

        kdjChart.timeScale().subscribeVisibleTimeRangeChange((range) => {
            mainChart.timeScale().setVisibleRange(range);
            volumeChart.timeScale().setVisibleRange(range);
            macdChart.timeScale().setVisibleRange(range);
            rsiChart.timeScale().setVisibleRange(range);
            skdjChart.timeScale().setVisibleRange(range);
            mkChart.timeScale().setVisibleRange(range);
            strategyChart.timeScale().setVisibleRange(range);
            obvChart.timeScale().setVisibleRange(range);
            mfiChart.timeScale().setVisibleRange(range);
            cciChart.timeScale().setVisibleRange(range);
            rocChart.timeScale().setVisibleRange(range);
            williamsChart.timeScale().setVisibleRange(range);
            trixChart.timeScale().setVisibleRange(range);
            bbiChart.timeScale().setVisibleRange(range);
        });

        trixChart.timeScale().subscribeVisibleTimeRangeChange((range) => {
            mainChart.timeScale().setVisibleRange(range);
            volumeChart.timeScale().setVisibleRange(range);
            macdChart.timeScale().setVisibleRange(range);
            rsiChart.timeScale().setVisibleRange(range);
            skdjChart.timeScale().setVisibleRange(range);
            mkChart.timeScale().setVisibleRange(range);
            strategyChart.timeScale().setVisibleRange(range);
            obvChart.timeScale().setVisibleRange(range);
            mfiChart.timeScale().setVisibleRange(range);
            cciChart.timeScale().setVisibleRange(range);
            rocChart.timeScale().setVisibleRange(range);
            williamsChart.timeScale().setVisibleRange(range);
            kdjChart.timeScale().setVisibleRange(range);
            bbiChart.timeScale().setVisibleRange(range);
        });

        bbiChart.timeScale().subscribeVisibleTimeRangeChange((range) => {
            mainChart.timeScale().setVisibleRange(range);
            volumeChart.timeScale().setVisibleRange(range);
            macdChart.timeScale().setVisibleRange(range);
            rsiChart.timeScale().setVisibleRange(range);
            skdjChart.timeScale().setVisibleRange(range);
            mkChart.timeScale().setVisibleRange(range);
            strategyChart.timeScale().setVisibleRange(range);
            obvChart.timeScale().setVisibleRange(range);
            mfiChart.timeScale().setVisibleRange(range);
            cciChart.timeScale().setVisibleRange(range);
            rocChart.timeScale().setVisibleRange(range);
            williamsChart.timeScale().setVisibleRange(range);
            kdjChart.timeScale().setVisibleRange(range);
            trixChart.timeScale().setVisibleRange(range);
        });
        
        // 数据设置完成后，同步所有图表的时间轴
        setTimeout(() => {
            syncAllCharts();
        }, 100);
        
        // 设置交叉线同步
        setupCrosshairSync();
        
    } catch (err) {
        console.error('加载 K线数据失败', err);
    } finally {
        // 隐藏加载状态
        hideLoading();
        
        // 移除loading样式
        $('.watchlist-item.loading').removeClass('loading');
    }
}

// 主图指标显示控制
function updateMainChartIndicators() {
    const showBB = document.getElementById('showBB').checked;
    const showSupertrend = document.getElementById('showSupertrend').checked;
    const showMultiMA = document.getElementById('showMultiMA').checked;
    const showZigZag = document.getElementById('showZigZag').checked;
    const showPivot = document.getElementById('showPivot').checked;
    const showDonchian = document.getElementById('showDonchian').checked;
    
    bbUpperSeries.applyOptions({ visible: showBB });
    bbLowerSeries.applyOptions({ visible: showBB });
    supertrendSeries.applyOptions({ visible: showSupertrend });
    ma14Series.applyOptions({ visible: showMultiMA });
    ma21Series.applyOptions({ visible: showMultiMA });
    ma35Series.applyOptions({ visible: showMultiMA });
    ma50Series.applyOptions({ visible: showMultiMA });
    ma100Series.applyOptions({ visible: showMultiMA });
    ma200Series.applyOptions({ visible: showMultiMA });
    
    // 新指标显示控制
    zigzag5Series.applyOptions({ visible: showZigZag });
    zigzag7Series.applyOptions({ visible: showZigZag });
    pivotSeries.applyOptions({ visible: showPivot });
    resistance1Series.applyOptions({ visible: showPivot });
    resistance2Series.applyOptions({ visible: showPivot });
    support1Series.applyOptions({ visible: showPivot });
    support2Series.applyOptions({ visible: showPivot });
    dcHigh20Series.applyOptions({ visible: showDonchian });
    dcLow20Series.applyOptions({ visible: showDonchian });
}

// 指标标签显示控制
function updateLabelsVisibility() {
    const showLabels = document.getElementById('showLabels').checked;
    
    // 主图指标标签 - 只使用实际存在的变量
    if (typeof bbUpperSeries !== 'undefined') bbUpperSeries.applyOptions({ title: showLabels ? 'BB上轨' : '' });
    if (typeof bbLowerSeries !== 'undefined') bbLowerSeries.applyOptions({ title: showLabels ? 'BB下轨' : '' });
    if (typeof supertrendSeries !== 'undefined') supertrendSeries.applyOptions({ title: showLabels ? '超级趋势' : '' });
    if (typeof ma14Series !== 'undefined') ma14Series.applyOptions({ title: showLabels ? 'MA14' : '' });
    if (typeof ma21Series !== 'undefined') ma21Series.applyOptions({ title: showLabels ? 'MA21' : '' });
    if (typeof ma35Series !== 'undefined') ma35Series.applyOptions({ title: showLabels ? 'MA35' : '' });
    if (typeof ma50Series !== 'undefined') ma50Series.applyOptions({ title: showLabels ? 'MA50' : '' });
    if (typeof ma100Series !== 'undefined') ma100Series.applyOptions({ title: showLabels ? 'MA100' : '' });
    if (typeof ma200Series !== 'undefined') ma200Series.applyOptions({ title: showLabels ? 'MA200' : '' });
    if (typeof zigzag5Series !== 'undefined') zigzag5Series.applyOptions({ title: showLabels ? 'ZigZag5%' : '' });
    if (typeof zigzag7Series !== 'undefined') zigzag7Series.applyOptions({ title: showLabels ? 'ZigZag7%' : '' });
    if (typeof pivotSeries !== 'undefined') pivotSeries.applyOptions({ title: showLabels ? 'PIVOT' : '' });
    if (typeof resistance1Series !== 'undefined') resistance1Series.applyOptions({ title: showLabels ? 'R1' : '' });
    if (typeof resistance2Series !== 'undefined') resistance2Series.applyOptions({ title: showLabels ? 'R2' : '' });
    if (typeof support1Series !== 'undefined') support1Series.applyOptions({ title: showLabels ? 'S1' : '' });
    if (typeof support2Series !== 'undefined') support2Series.applyOptions({ title: showLabels ? 'S2' : '' });
    if (typeof dcHigh20Series !== 'undefined') dcHigh20Series.applyOptions({ title: showLabels ? 'DC高' : '' });
    if (typeof dcLow20Series !== 'undefined') dcLow20Series.applyOptions({ title: showLabels ? 'DC低' : '' });
    
    // 附图指标标签
    if (typeof macdDiffSeries !== 'undefined') macdDiffSeries.applyOptions({ title: showLabels ? 'DIF' : '' });
    if (typeof macdSignalSeries !== 'undefined') macdSignalSeries.applyOptions({ title: showLabels ? 'DEA' : '' });
    
    if (typeof stochRsiKSeries !== 'undefined') stochRsiKSeries.applyOptions({ title: showLabels ? 'Stoch RSI K' : '' });
    if (typeof stochRsiDSeries !== 'undefined') stochRsiDSeries.applyOptions({ title: showLabels ? 'Stoch RSI D' : '' });
    
    if (typeof skdjKSeries !== 'undefined') skdjKSeries.applyOptions({ title: showLabels ? 'SKDJ K' : '' });
    if (typeof skdjDSeries !== 'undefined') skdjDSeries.applyOptions({ title: showLabels ? 'SKDJ D' : '' });
    
    if (typeof td9Series !== 'undefined') td9Series.applyOptions({ title: showLabels ? 'TD9信号' : '' });
    if (typeof emaStrategySeries !== 'undefined') emaStrategySeries.applyOptions({ title: showLabels ? 'EMA策略' : '' });
    if (typeof superBandSeries !== 'undefined') superBandSeries.applyOptions({ title: showLabels ? '超级波段' : '' });
    
    if (typeof obvSeries !== 'undefined') obvSeries.applyOptions({ title: showLabels ? 'OBV' : '' });
    if (typeof mfiSeries !== 'undefined') mfiSeries.applyOptions({ title: showLabels ? 'MFI14' : '' });
    if (typeof cci20Series !== 'undefined') cci20Series.applyOptions({ title: showLabels ? 'CCI20' : '' });
    if (typeof cci14Series !== 'undefined') cci14Series.applyOptions({ title: showLabels ? 'CCI14' : '' });
    if (typeof roc10Series !== 'undefined') roc10Series.applyOptions({ title: showLabels ? 'ROC10' : '' });
    if (typeof roc20Series !== 'undefined') roc20Series.applyOptions({ title: showLabels ? 'ROC20' : '' });
    if (typeof williamsR14Series !== 'undefined') williamsR14Series.applyOptions({ title: showLabels ? 'William %R14' : '' });
    
    // 检查KDJ系列是否存在
    if (typeof kdjKSeries !== 'undefined') kdjKSeries.applyOptions({ title: showLabels ? 'KDJ K' : '' });
    if (typeof kdjDSeries !== 'undefined') kdjDSeries.applyOptions({ title: showLabels ? 'KDJ D' : '' });
    if (typeof kdjJSeries !== 'undefined') kdjJSeries.applyOptions({ title: showLabels ? 'KDJ J' : '' });
    
    // 检查TRIX和BBI系列是否存在
    if (typeof trixSeries !== 'undefined') trixSeries.applyOptions({ title: showLabels ? 'TRIX' : '' });
    if (typeof trixSignalSeries !== 'undefined') trixSignalSeries.applyOptions({ title: showLabels ? 'TRIX信号线' : '' });
    if (typeof bbiSeries !== 'undefined') bbiSeries.applyOptions({ title: showLabels ? 'BBI' : '' });
}

// 指标显示控制
function updateIndicatorsVisibility() {
    const showVol = document.getElementById('showVol').checked;
    const showMacd = document.getElementById('showMacd').checked;
    const showRsi = document.getElementById('showRsi').checked;
    const showSkdj = document.getElementById('showSkdj').checked;
    const showMk = document.getElementById('showMk').checked;
    const showStrategy = document.getElementById('showStrategy').checked;
    const showObv = document.getElementById('showObv').checked;
    const showMfi = document.getElementById('showMfi').checked;
    const showCci = document.getElementById('showCci').checked;
    const showRoc = document.getElementById('showRoc').checked;
    const showWilliams = document.getElementById('showWilliams').checked;
    const showKdj = document.getElementById('showKdj').checked;
    const showTrix = document.getElementById('showTrix').checked;
    const showBbi = document.getElementById('showBbi').checked;

    document.getElementById('volumeSection').style.display = showVol ? 'block' : 'none';
    document.getElementById('macdSection').style.display = showMacd ? 'block' : 'none';
    document.getElementById('rsiSection').style.display = showRsi ? 'block' : 'none';
    document.getElementById('skdjSection').style.display = showSkdj ? 'block' : 'none';
    document.getElementById('mkSection').style.display = showMk ? 'block' : 'none';
    document.getElementById('strategySection').style.display = showStrategy ? 'block' : 'none';
    document.getElementById('obvSection').style.display = showObv ? 'block' : 'none';
    document.getElementById('mfiSection').style.display = showMfi ? 'block' : 'none';
    document.getElementById('cciSection').style.display = showCci ? 'block' : 'none';
    document.getElementById('rocSection').style.display = showRoc ? 'block' : 'none';
    document.getElementById('williamsSection').style.display = showWilliams ? 'block' : 'none';
    document.getElementById('kdjSection').style.display = showKdj ? 'block' : 'none';
    document.getElementById('trixSection').style.display = showTrix ? 'block' : 'none';
    document.getElementById('bbiSection').style.display = showBbi ? 'block' : 'none';
}

// 搜索按钮
document.getElementById('searchBtn').addEventListener('click', () => {
    const symbol = document.getElementById('stockInput').value.trim();
    if(symbol) loadKline(symbol);
});

// 加入自选按钮
document.getElementById('addWatchBtn').addEventListener('click', async () => {
    const symbol = document.getElementById('stockInput').value.trim();
    if(!symbol) return alert('请输入股票代码或名称');

    // 处理股票代码
    const processedSymbol = processStockCode(symbol);

    try {
        // 获取股票基本信息，包括中文名称
        const stockInfoRes = await fetch(`http://127.0.0.1:8000/api/stock_info?symbol=${processedSymbol}`);
        const stockInfoJson = await stockInfoRes.json();

        if (stockInfoRes.ok) {
            const stockInfo = stockInfoJson.data;

            // 获取实时行情数据以获取真实价格和涨幅
            const realtimeRes = await fetch(`http://127.0.0.1:8000/api/realtime_price?symbol=${processedSymbol}`);
            const realtimeJson = await realtimeRes.json();

            let currentPrice = '--';
            let currentChange = '--';
            let turnoverRate = '--';

            if (realtimeRes.ok && realtimeJson.data) {
                const realtimeData = realtimeJson.data;
                currentPrice = realtimeData.currentPrice ? realtimeData.currentPrice.toFixed(2) : '--';
                currentChange = realtimeData.change ? realtimeData.change + '%' : '--';
                turnoverRate = realtimeData.turnoverRate ? realtimeData.turnoverRate + '%' : '--';
            }

            // 使用真实的价格、涨幅和换手率数据
            const stock = {
                code: processedSymbol,
                name: stockInfo.name,
                price: currentPrice,
                change: currentChange,
                turnoverRate: turnoverRate
            };

            if(!watchlist.find(s=>s.code===processedSymbol)) {
                watchlist.push(stock);
                updateWatchlistTable();
            } else {
                alert('该股票已在自选列表中');
            }
        } else {
            alert('获取股票信息失败: ' + stockInfoJson.error);
        }
    } catch (err) {
        console.error('获取股票信息失败', err);
        alert('获取股票信息失败，请检查网络连接');
    }
});

// 主图指标显示控制事件
document.getElementById('showBB').addEventListener('change', updateMainChartIndicators);
document.getElementById('showSupertrend').addEventListener('change', updateMainChartIndicators);
document.getElementById('showMultiMA').addEventListener('change', updateMainChartIndicators);
document.getElementById('showZigZag').addEventListener('change', updateMainChartIndicators);
document.getElementById('showPivot').addEventListener('change', updateMainChartIndicators);
document.getElementById('showDonchian').addEventListener('change', updateMainChartIndicators);

// 标签显示控制事件
document.getElementById('showLabels').addEventListener('change', updateLabelsVisibility);

// 指标显示控制事件
document.getElementById('showVol').addEventListener('change', updateIndicatorsVisibility);
document.getElementById('showMacd').addEventListener('change', updateIndicatorsVisibility);
document.getElementById('showRsi').addEventListener('change', updateIndicatorsVisibility);
document.getElementById('showSkdj').addEventListener('change', updateIndicatorsVisibility);
document.getElementById('showMk').addEventListener('change', updateIndicatorsVisibility);
document.getElementById('showStrategy').addEventListener('change', updateIndicatorsVisibility);
document.getElementById('showObv').addEventListener('change', updateIndicatorsVisibility);
document.getElementById('showMfi').addEventListener('change', updateIndicatorsVisibility);
document.getElementById('showCci').addEventListener('change', updateIndicatorsVisibility);
document.getElementById('showRoc').addEventListener('change', updateIndicatorsVisibility);
document.getElementById('showWilliams').addEventListener('change', updateIndicatorsVisibility);
document.getElementById('showKdj').addEventListener('change', updateIndicatorsVisibility);
document.getElementById('showTrix').addEventListener('change', updateIndicatorsVisibility);
document.getElementById('showBbi').addEventListener('change', updateIndicatorsVisibility);

// 窗口大小变化时重新调整图表大小和联动
window.addEventListener('resize', () => {
    const chartWidth = getChartWidth();
    const allCharts = [mainChart, volumeChart, macdChart, rsiChart, skdjChart, mkChart, strategyChart, obvChart, mfiChart, cciChart, rocChart, williamsChart, kdjChart, trixChart, bbiChart];

    allCharts.forEach(chart => {
        if (chart) {
            chart.applyOptions({ width: chartWidth });
        }
    });

    // 重新同步时间轴
    syncAllCharts();
});

// 同步所有图表的时间轴
function syncAllCharts() {
    try {
        const mainRange = mainChart.timeScale().getVisibleRange();
        if (mainRange && mainRange.from !== null && mainRange.to !== null) {
            const allCharts = [volumeChart, macdChart, rsiChart, skdjChart, mkChart, strategyChart, obvChart, mfiChart, cciChart, rocChart, williamsChart, kdjChart, trixChart, bbiChart];
            allCharts.forEach(chart => {
                if (chart && chart.timeScale) {
                    try {
                        chart.timeScale().setVisibleRange(mainRange);
                    } catch (error) {
                        console.warn('同步图表时间轴失败:', error);
                    }
                }
            });
        }
    } catch (error) {
        console.warn('获取主图时间轴范围失败:', error);
    }
}

// 设置交叉线同步功能
function setupCrosshairSync() {
    // 定义所有需要同步的图表
    const allCharts = [mainChart, volumeChart, macdChart, rsiChart, skdjChart, mkChart, strategyChart, obvChart, mfiChart, cciChart, rocChart, williamsChart, kdjChart, trixChart, bbiChart];
    
    // 为每个图表设置交叉线同步
    allCharts.forEach(chart => {
        if (!chart) return;
        
        // 订阅交叉线移动事件
        chart.subscribeCrosshairMovement((param) => {
            // 获取当前鼠标位置的时间点
            const time = param.time;
            
            if (!time) return;
            
            // 同步所有其他图表到相同的时间点
            allCharts.forEach(otherChart => {
                if (otherChart && otherChart !== chart) {
                    try {
                        // 设置交叉线位置
                        otherChart.setCrosshairPosition(param.point.x, param.point.y, param.series);
                    } catch (error) {
                        // 忽略同步错误
                    }
                }
            });
        });
    });
}

// 初始化时不同步所有图表，等待数据加载完成后再同步
// 同步操作将在loadKline函数的数据设置完成后执行

// 监听主图时间轴变化，自动同步所有附图
mainChart.timeScale().subscribeVisibleTimeRangeChange(syncAllCharts);

// 添加键盘快捷键支持
window.addEventListener('keydown', (e) => {
    // 左右箭头键滚动时间轴
    if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
        e.preventDefault();
        const scrollAmount = e.key === 'ArrowLeft' ? -1 : 1;
        mainChart.timeScale().scrollByPosition(scrollAmount * 10, false);
        syncAllCharts();
    }

    // +/- 键缩放时间轴
    if (e.key === '+' || e.key === '-' || e.key === '=') {
        e.preventDefault();
        const zoomAmount = e.key === '+' || e.key === '=' ? 0.8 : 1.2;
        mainChart.timeScale().applyOptions({
            barSpacing: mainChart.timeScale().options().barSpacing * zoomAmount
        });
        syncAllCharts();
    }
});

// 初始化时更新自选股表格
updateWatchlistTable();

// 初始化主图鼠标事件
setupMainChartMouseEvents();
</script>
</body>
</html>
